<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.user.mapper.UserTokenMapper">
    <resultMap id="BaseResultMap" type="com.user.entity.UserToken">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="refresh_token" property="refreshToken"/>
        <result column="expires_at" property="expiresAt"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <insert id="insert" parameterType="com.user.entity.UserToken" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `user_token` (user_id, refresh_token, expires_at)
        VALUES (#{userId}, #{refreshToken}, #{expiresAt})
    </insert>

    <update id="update" parameterType="com.user.entity.UserToken">
        UPDATE `user_token`
        <set>
            <if test="refreshToken != null">refresh_token = #{refreshToken},</if>
            <if test="expiresAt != null">expires_at = #{expiresAt},</if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM `user_token` WHERE id = #{id}
    </delete>

    <delete id="deleteByUserId">
        DELETE FROM `user_token` WHERE user_id = #{userId}
    </delete>

    <select id="findById" resultMap="BaseResultMap">
        SELECT * FROM `user_token` WHERE id = #{id}
    </select>

    <select id="findByUserId" resultMap="BaseResultMap">
        SELECT * FROM `user_token` WHERE user_id = #{userId}
    </select>

    <select id="findByRefreshToken" resultMap="BaseResultMap">
        SELECT * FROM `user_token` WHERE refresh_token = #{refreshToken}
    </select>

    <insert id="saveOrUpdate" parameterType="com.user.entity.UserToken">
        INSERT INTO `user_token` (user_id, refresh_token, expires_at)
        VALUES (#{userId}, #{refreshToken}, #{expiresAt})
        ON DUPLICATE KEY UPDATE
            refresh_token = VALUES(refresh_token),
            expires_at = VALUES(expires_at),
            updated_at = CURRENT_TIMESTAMP
    </insert>
</mapper>

